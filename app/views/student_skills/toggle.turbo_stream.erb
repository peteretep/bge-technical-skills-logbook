<%# Update the individual skill row %>
<%= turbo_stream.replace "skill_#{@skill.id}" do %>
  <div id="skill_<%= @skill.id %>" class="flex items-center gap-3 py-2 px-3 <%= @student_skill.demonstrated? ? 'bg-green-50' : 'bg-gray-50 hover:bg-gray-100' %> rounded transition">
    <%= check_box_tag "skill_#{@skill.id}", 
        "1", 
        @student_skill.demonstrated?,
        data: { 
          student_id: @student.id,
          skill_id: @skill.id,
          action: "change->skills#toggle"
        },
        class: "w-4 h-4" %>
    <span class="text-sm flex-1 <%= @student_skill.demonstrated? ? '' : 'text-gray-700' %>">
      <%= @skill.description %>
    </span>
    <% if @student_skill.demonstrated? && @student_skill.demonstrated_at %>
      <span class="text-xs text-gray-500"><%= @student_skill.demonstrated_at.strftime('%d %b') %></span>
    <% end %>
  </div>
<% end %>

<%# Update the level header with counts and badge button %>
<%= turbo_stream.replace "level_header_#{@section.id}_#{@level}" do %>
  <div id="level_header_<%= @section.id %>_<%= @level %>" class="flex items-center justify-between mb-3">
    <div class="flex items-center gap-2 flex-wrap">
      <span class="text-xl"><%= @skill.level_icon %></span>
      <span class="font-bold <%= @level == :bronze ? 'text-orange-700' : @level == :silver ? 'text-gray-600' : 'text-yellow-600' %>">
        <%= @level.to_s.upcase %> LEVEL
      </span>
      
      <% if @has_badge %>
        <span class="px-2 py-0.5 bg-green-100 text-green-800 text-xs rounded-full">Badge Awarded</span>
      <% elsif @percentage >= 75 %>
        <span class="px-2 py-0.5 bg-blue-100 text-blue-800 text-xs rounded-full">Ready for Badge (<%= @percentage %>%)</span>
      <% elsif @percentage > 0 %>
        <span class="px-2 py-0.5 bg-yellow-100 text-yellow-800 text-xs rounded-full"><%= @percentage %>% complete</span>
      <% end %>
    </div>
    
    <div class="flex items-center gap-3">
      <div class="text-sm text-gray-600"><%= @demonstrated_count %>/<%= @total_skills %> demonstrated</div>
      <% if @ready_for_badge %>
        <%= button_to "Award #{@level.to_s.capitalize} Badge", 
            award_badge_student_path(@student, section_id: @section.id, level: @level),
            method: :post,
            data: { turbo_confirm: "Award #{@level} badge to #{@student.full_name}?" },
            class: "px-3 py-1 bg-gradient-to-r #{@level == :bronze ? 'from-orange-500 to-orange-600' : @level == :silver ? 'from-gray-400 to-gray-500' : 'from-yellow-500 to-yellow-600'} text-white text-sm rounded-lg font-medium hover:opacity-90" %>
      <% end %>
    </div>
  </div>
<% end %>

<%# Update badge counts in header %>
<%= turbo_stream.replace "badge_counts" do %>
  <div id="badge_counts" class="flex gap-3">
    <% bronze_count = @student.badges.where(level: :bronze).count %>
    <% silver_count = @student.badges.where(level: :silver).count %>
    <% gold_count = @student.badges.where(level: :gold).count %>
    
    <div class="text-center px-4 py-2 <%= bronze_count > 0 ? 'bg-orange-50 border-orange-200' : 'bg-gray-50 border-gray-300' %> rounded-lg border">
      <div class="text-2xl font-bold <%= bronze_count > 0 ? 'text-orange-600' : 'text-gray-500' %>"><%= bronze_count %></div>
      <div class="text-xs <%= bronze_count > 0 ? 'text-orange-700' : 'text-gray-600' %>">ðŸ¥‰ Bronze</div>
    </div>
    <div class="text-center px-4 py-2 <%= silver_count > 0 ? 'bg-gray-100 border-gray-400' : 'bg-gray-50 border-gray-300' %> rounded-lg border">
      <div class="text-2xl font-bold <%= silver_count > 0 ? 'text-gray-700' : 'text-gray-500' %>"><%= silver_count %></div>
      <div class="text-xs text-gray-600">ðŸ¥ˆ Silver</div>
    </div>
    <div class="text-center px-4 py-2 <%= gold_count > 0 ? 'bg-yellow-50 border-yellow-400' : 'bg-gray-50 border-gray-300' %> rounded-lg border">
      <div class="text-2xl font-bold <%= gold_count > 0 ? 'text-yellow-600' : 'text-gray-500' %>"><%= gold_count %></div>
      <div class="text-xs text-gray-600">ðŸ¥‡ Gold</div>
    </div>
  </div>
<% end %>